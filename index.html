
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restaurant Reservations Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
  <style>
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Simple fade-in animation */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
  </style>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime"
    }
  }
  </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  
  <script type="text/babel" data-type="module">
    // --- INICIO DEL CÓDIGO COMBINADO DE LA APLICACIÓN ---

    // 1. Importaciones principales y helpers
    import React, { useState, useEffect, useCallback, useMemo } from 'react';
    import ReactDOM from 'react-dom/client';

    const getLocalDate = () => {
        const date = new Date();
        const timezoneOffset = date.getTimezoneOffset() * 60000;
        const localDate = new Date(date.getTime() - timezoneOffset);
        return localDate.toISOString().split('T')[0];
    };

    // 2. Definiciones de Tipos (de types.ts)
    const ReservationType = {
        LUNCH: 'ALMUERZO',
        DINNER: 'CENA'
    };

    // 3. Componentes de Iconos (de components/Icons.tsx)
    const PlusIcon = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
      </svg>
    );

    const MdsLogo = ({ className }) => (
        <svg className={className} viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="MDS Logo">
            <circle cx="50" cy="50" r="50" fill="#4f46e5" />
            <text x="50" y="52" dominantBaseline="middle" textAnchor="middle" fill="white" fontSize="40" fontFamily="'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif" fontWeight="600">
                MDS
            </text>
        </svg>
    );

    const LinkedInIcon = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
      </svg>
    );

    const CheckCircleIcon = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const LoadingSpinner = ({ className }) => (
        <svg className={`animate-spin ${className}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    );

    // 4. Hook Personalizado (de hooks/useReservations.ts)
    const useReservations = () => {
        const SHEET_APP_URL = 'https://script.google.com/macros/s/AKfycbxEsBkxtwNacKn8gmcsTxWu2CUzwilfpG71HQOsuvrZL0IXmAr3AjC9OjIohtXoewx-/exec'; 
        const [reservations, setReservations] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [, setForceUpdate] = useState(0);

        const fetchReservations = useCallback(async () => {
            setLoading(true);
            setError(null);
            try {
                const res = await fetch(`${SHEET_APP_URL}?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error(`Error en la solicitud: ${res.status}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                const parsedData = data.map((r) => ({
                    ...r,
                    id: String(r.id),
                    cantidad: Number(r.cantidad) || 1,
                    arrived: r.arrived === true || String(r.arrived).toLowerCase() === 'true',
                }));
                setReservations(parsedData);
            } catch (e) {
                console.error("Fallo al obtener las reservas:", e);
                setError('No se pudieron cargar las reservas. Verifica la conexión y la URL del script.');
            } finally {
                setLoading(false);
            }
        }, []);

        useEffect(() => {
            fetchReservations();
            const intervalId = setInterval(() => setForceUpdate(tick => tick + 1), 60000); 
            return () => clearInterval(intervalId);
        }, [fetchReservations]);

        const addReservation = useCallback(async (newReservation) => {
            setLoading(true);
            try {
                const response = await fetch(SHEET_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'addReservation', reservation: newReservation })
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'Fallo al agregar la reserva');
                await fetchReservations(); 
            } catch (e) {
                console.error("Fallo al agregar la reserva:", e);
                setError('No se pudo guardar la reserva. Por favor, inténtalo de nuevo.');
                setLoading(false);
                throw e;
            }
        }, [fetchReservations]);

        const updateReservationStatus = useCallback(async (id, arrived) => {
            const originalReservations = [...reservations];
            setReservations(prev => prev.map(res => res.id === id ? { ...res, arrived } : res));
            try {
                 const response = await fetch(SHEET_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'updateStatus', id, arrived })
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'Fallo al actualizar el estado');
            } catch (e) {
                console.error("Fallo al actualizar el estado:", e);
                setError('No se pudo actualizar el estado de la reserva.');
                setReservations(originalReservations);
            }
        }, [reservations]);

        return { reservations, addReservation, updateReservationStatus, loading, error, refetch: fetchReservations };
    };

    // 5. Componente Formulario (de components/ReservationForm.tsx)
    const ReservationForm = ({ onAddReservation, isSubmitting }) => {
      const [nombre, setNombre] = useState('');
      const [habitacion, setHabitacion] = useState('');
      const [fecha, setFecha] = useState(getLocalDate());
      const [hora, setHora] = useState('');
      const [cantidad, setCantidad] = useState(1);
      const [telefono, setTelefono] = useState('');
      const [tipo, setTipo] = useState('');
      const [observacion, setObservacion] = useState('');
      const [showSuccess, setShowSuccess] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!tipo) {
          alert('Por favor, selecciona un tipo de reserva.');
          return;
        }
        try {
            await onAddReservation({ nombre, habitacion, fecha, hora, cantidad, telefono, tipo, observacion });
            setNombre(''); setHabitacion(''); setFecha(getLocalDate()); setHora('');
            setCantidad(1); setTelefono(''); setTipo(''); setObservacion('');
            setShowSuccess(true);
            setTimeout(() => setShowSuccess(false), 3000);
        } catch (error) {
            console.error("Submission failed, form data preserved.", error);
        }
      };

      const formFieldClasses = "block w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-gray-700 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out";

      return (
        <div className="bg-white rounded-xl shadow-lg p-6 mb-8 relative">
           {showSuccess && (
            <div className="absolute top-0 left-0 right-0 p-4 bg-green-500 text-white rounded-t-xl flex items-center justify-center fade-in">
                <CheckCircleIcon className="w-6 h-6 mr-2" />
                <span>¡La reserva se cargó con éxito!</span>
            </div>
          )}
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Reservar Mesa</h2>
          <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
            <input type="text" value={nombre} onChange={e => setNombre(e.target.value)} placeholder="Nombre" required className={formFieldClasses} />
            <input type="text" value={habitacion} onChange={e => setHabitacion(e.target.value)} placeholder="Habitación" className={formFieldClasses} />
            <input type="date" value={fecha} onChange={e => setFecha(e.target.value)} required className={formFieldClasses} style={{ colorScheme: 'light' }} />
            <input type="time" value={hora} onChange={e => setHora(e.target.value)} required className={formFieldClasses} />
            <input type="number" value={cantidad} onChange={e => setCantidad(parseInt(e.target.value, 10))} placeholder="Cantidad" min="1" required className={formFieldClasses} />
            <input type="tel" value={telefono} onChange={e => setTelefono(e.target.value)} placeholder="Teléfono" className={formFieldClasses} />
            <select value={tipo} onChange={e => setTipo(e.target.value)} required className={formFieldClasses}>
              <option value="" disabled>-- Selecciona Tipo --</option>
              <option value={ReservationType.LUNCH}>Almuerzo</option>
              <option value={ReservationType.DINNER}>Cena</option>
            </select>
            <textarea value={observacion} onChange={e => setObservacion(e.target.value)} placeholder="Observaciones" className={`${formFieldClasses} md:col-span-2`}></textarea>
            <button type="submit" disabled={isSubmitting} className="md:col-span-2 w-full flex items-center justify-center bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:bg-indigo-400 disabled:cursor-not-allowed">
              {isSubmitting ? ( <><LoadingSpinner className="w-5 h-5 mr-3" />Agregando...</> ) : ( <><PlusIcon className="w-5 h-5 mr-2" />Agregar Reserva</> )}
            </button>
          </form>
        </div>
      );
    };

    // 6. Componente Tabla de Reservas (de components/ReservationTable.tsx)
    const ReservationRow = ({ reservation, isFuture, onUpdateStatus }) => {
        const reservationDateTime = new Date(`${reservation.fecha}T${reservation.hora}`);
        const isInvalidDate = isNaN(reservationDateTime.getTime());
        let rowClass = 'bg-white hover:bg-gray-50';
        
        if (!isFuture && !isInvalidDate) {
            const diffMinutes = (new Date().getTime() - reservationDateTime.getTime()) / 60000;
            if (reservation.arrived) rowClass = 'bg-green-100 text-green-800';
            else if (diffMinutes > 15) rowClass = 'bg-red-200 text-red-900';
            else if (diffMinutes > 10) rowClass = 'bg-yellow-100 text-yellow-900';
        } else if (reservation.arrived) {
             rowClass = 'bg-green-100 text-green-800';
        }

        return (
            <tr className={`${rowClass} border-b border-gray-200 transition-colors duration-300`}>
                {isFuture && <td className="px-5 py-4 whitespace-nowrap">{reservation.fecha}</td>}
                <td className="px-5 py-4 whitespace-nowrap font-medium">{reservation.nombre}</td>
                <td className="px-5 py-4 whitespace-nowrap">{reservation.habitacion}</td>
                <td className="px-5 py-4 whitespace-nowrap">{reservation.hora}</td>
                <td className="px-5 py-4 whitespace-nowrap text-center">{reservation.cantidad}</td>
                <td className="px-5 py-4 whitespace-nowrap">{reservation.telefono}</td>
                {isFuture && <td className="px-5 py-4 whitespace-nowrap">{reservation.tipo}</td>}
                <td className="px-5 py-4">{reservation.observacion}</td>
                <td className="px-5 py-4 text-center">
                    <input type="checkbox" checked={reservation.arrived} onChange={(e) => onUpdateStatus(reservation.id, e.target.checked)}
                        className="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" />
                </td>
            </tr>
        );
    };

    const ReservationTable = ({ title, reservations, isFuture = false, onUpdateStatus, totalGuests }) => {
      const headers = isFuture ? ['Fecha', 'Nombre', 'Habitación', 'Hora', 'Cant.', 'Teléfono', 'Tipo', 'Observación', 'Llegó'] : ['Nombre', 'Habitación', 'Hora', 'Cant.', 'Teléfono', 'Observación', 'Llegó'];
      return (
        <div className="bg-white rounded-xl shadow-lg p-6 mb-8 overflow-hidden">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
            {totalGuests !== undefined && (
              <div className="bg-indigo-100 text-indigo-800 text-sm font-semibold px-4 py-1.5 rounded-full flex items-center">
                <span>Total Comensales: {totalGuests}</span>
              </div>
            )}
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left text-gray-600">
              <thead className="bg-gray-50 text-xs text-gray-700 uppercase tracking-wider">
                <tr>{headers.map(h => <th key={h} scope="col" className="px-5 py-3 font-semibold">{h}</th>)}</tr>
              </thead>
              <tbody>
                {reservations.length > 0 ? (
                    reservations.map(res => <ReservationRow key={res.id} reservation={res} isFuture={isFuture} onUpdateStatus={onUpdateStatus} />)
                ) : (
                    <tr><td colSpan={headers.length} className="text-center py-10 px-5 text-gray-500">No hay reservas para mostrar.</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    // 7. Componente Principal (de App.tsx)
    const App = () => {
      const { reservations, addReservation, updateReservationStatus, loading, error, refetch } = useReservations();
      const today = useMemo(() => getLocalDate(), []);

      const [ todayLunchReservations, todayDinnerReservations, futureReservations, totalLunchGuests, totalDinnerGuests ] = useMemo(() => {
        const todayL = [], todayD = [], future = [];
        let lunchGuests = 0, dinnerGuests = 0;
        
        reservations.forEach(r => {
          if (r.fecha === today) {
            if (r.tipo === ReservationType.LUNCH) { todayL.push(r); lunchGuests += r.cantidad; } 
            else if (r.tipo === ReservationType.DINNER) { todayD.push(r); dinnerGuests += r.cantidad; }
          } else if (r.fecha > today) {
            future.push(r);
          }
        });

        todayL.sort((a, b) => a.hora.localeCompare(b.hora));
        todayD.sort((a, b) => a.hora.localeCompare(b.hora));
        future.sort((a, b) => a.fecha.localeCompare(b.fecha) || a.hora.localeCompare(b.hora));
        
        return [todayL, todayD, future, lunchGuests, dinnerGuests];
      }, [reservations, today]);

      return (
        <div className="min-h-screen bg-gray-100 text-gray-800 flex flex-col">
          <header className="bg-white shadow-md">
            <div className="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex items-center">
                <MdsLogo className="h-10 w-10 mr-4" />
                <h1 className="text-3xl font-bold text-gray-900">Gestor de Reservas</h1>
            </div>
          </header>
          <main className="py-10 flex-grow">
            <div className="max-w-7xl mx-auto sm:px-6 lg:px-8">
              <ReservationForm onAddReservation={addReservation} isSubmitting={loading} />
              {error && (
                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative my-6 fade-in" role="alert">
                  <strong className="font-bold">Error: </strong>
                  <span className="block sm:inline">{error}</span>
                  <button onClick={() => refetch()} className="ml-4 bg-red-700 text-white font-bold py-1 px-3 rounded hover:bg-red-800 transition-colors">Reintentar</button>
                </div>
              )}
              {loading && reservations.length === 0 && !error ? (
                <div className="flex justify-center items-center py-20">
                  <LoadingSpinner className="w-12 h-12 text-indigo-600" />
                  <p className="ml-4 text-lg text-gray-600">Cargando reservas...</p>
                </div>
              ) : (
                <div className="space-y-8 mt-8 fade-in">
                  <ReservationTable title="Reservas de Hoy - Almuerzo" reservations={todayLunchReservations} onUpdateStatus={updateReservationStatus} totalGuests={totalLunchGuests} />
                  <ReservationTable title="Reservas de Hoy - Cena" reservations={todayDinnerReservations} onUpdateStatus={updateReservationStatus} totalGuests={totalDinnerGuests} />
                  <ReservationTable title="Reservas Futuras" reservations={futureReservations} isFuture={true} onUpdateStatus={updateReservationStatus} />
                </div>
              )}
            </div>
          </main>
          <footer className="bg-white border-t border-gray-200 py-4">
             <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center text-sm">
                <p className="text-gray-600">Restaurant Reservations Manager</p>
                <a href="https://www.linkedin.com/in/martin-schupp-07332511/" target="_blank" rel="noopener noreferrer"
                    className="flex items-center text-gray-600 hover:text-indigo-600 transition-colors duration-200" aria-label="MDS Operating Log on LinkedIn">
                    <LinkedInIcon className="w-5 h-5" />
                    <span className="ml-2 font-medium">MDS Operating Log</span>
                </a>
            </div>
          </footer>
        </div>
      );
    };

    // 8. Punto de Entrada de la Aplicación (de index.tsx)
    const rootElement = document.getElementById('root');
    if (!rootElement) {
      throw new Error("Could not find root element to mount to");
    }
    const root = ReactDOM.createRoot(rootElement);
    root.render(
      <React.StrictMode>
        <App />
      </React.StrictMode>
    );

    // --- FIN DEL CÓDIGO COMBINADO DE LA APLICACIÓN ---
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
